{% extends "base.html" %}

{% block title %}Login - Azure Resource Inventory{% endblock %}

{% block content %}
<div class="row justify-content-center" style="margin-top: 5rem;">
    <div class="col-md-6 col-lg-5">
        <div class="logo-container">
            <i class="bi bi-cloud-check-fill"></i>
            <h2 style="color: white; margin-top: 1rem;">Azure Resource Inventory</h2>
        </div>
        
        <div class="card">
            <div class="card-body text-center p-4">
                <h4 class="mb-3">Welcome</h4>
                <p class="text-muted mb-4">
                    Sign in with your Microsoft account to generate comprehensive Azure resource inventories
                </p>
                
                <div id="errorAlert" class="alert alert-danger" role="alert" style="display: none;">
                    <i class="bi bi-exclamation-triangle"></i> <span id="errorMessage"></span>
                </div>
                
                <div class="mb-3 text-start">
                    <label for="tenantInput" class="form-label">Azure Tenant ID</label>
                    <input 
                        type="text" 
                        class="form-control" 
                        id="tenantInput" 
                        placeholder="e.g., xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
                        value="{{ tenant_id if tenant_id else '' }}"
                    >
                    <div class="form-text">Enter your Azure AD Tenant ID (GUID format)</div>
                </div>
                
                <button id="loginBtn" class="btn btn-primary btn-lg w-100 mb-3">
                    <i class="bi bi-microsoft"></i> Sign in with Microsoft
                </button>
                
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="bi bi-shield-check"></i> Secure authentication via Azure AD
                    </small>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-body">
                <h6 class="text-center mb-3">Features</h6>
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <i class="bi bi-check-circle-fill text-success"></i> 
                        Complete Azure resource documentation
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-check-circle-fill text-success"></i> 
                        Interactive Excel reports
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-check-circle-fill text-success"></i> 
                        Visual network diagrams
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-check-circle-fill text-success"></i> 
                        Durable storage in Azure Files
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    const tenantInput = document.getElementById('tenantInput');
    const loginBtn = document.getElementById('loginBtn');
    const errorAlert = document.getElementById('errorAlert');
    const errorMessage = document.getElementById('errorMessage');

    // Load saved tenant from localStorage
    const savedTenant = localStorage.getItem('azureTenantId');
    if (savedTenant && !tenantInput.value) {
        tenantInput.value = savedTenant;
    }

    // Validate GUID format
    function isValidGuid(str) {
        const guidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
        return guidPattern.test(str);
    }

    function showError(message) {
        errorMessage.textContent = message;
        errorAlert.style.display = 'block';
        setTimeout(() => {
            errorAlert.style.display = 'none';
        }, 5000);
    }

    loginBtn.onclick = (e) => {
        e.preventDefault();
        const tenantId = tenantInput.value.trim();
        
        if (!tenantId) {
            showError('Please enter a Tenant ID');
            return;
        }

        if (!isValidGuid(tenantId)) {
            showError('Please enter a valid Tenant ID in GUID format (e.g., xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx)');
            return;
        }

        // Save tenant to localStorage for next time
        localStorage.setItem('azureTenantId', tenantId);
        
        // Build auth URL with tenant
        window.location.href = `/login?tenant=${encodeURIComponent(tenantId)}`;
    };

    // Allow Enter key to submit
    tenantInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            loginBtn.click();
        }
    });
</script>
{% endblock %}
