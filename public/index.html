<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Azure Resource Inventory Runner</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Noto Sans', 'Helvetica Neue', Arial, 'Apple Color Emoji', 'Segoe UI Emoji'; margin: 24px; }
    .row { margin: 12px 0; }
    button { padding: 8px 12px; }
    select, input { padding: 6px; min-width: 320px; }
    .hidden { display: none; }
    #status { white-space: pre-line; background: #f7f7f7; padding: 10px; border-radius: 6px; }
    .muted { color: #666; }
    a { color: #0366d6; }
  </style>
</head>
<body>
  <h2>Azure Resource Inventory (Invoke-ARI) - App Service Frontend</h2>

  <div class="row" id="authRow">
    <button id="loginBtn">Sign in with Microsoft</button>
    <button id="logoutBtn" class="hidden">Sign out</button>
    <span id="userSpan" class="muted"></span>
  </div>

  <div id="app" class="hidden">
    <div class="row">
      <label>Tenant</label><br />
      <select id="tenantSelect"></select>
    </div>
    <div class="row">
      <label>Subscription (optional)</label><br />
      <select id="subscriptionSelect">
        <option value="">All accessible in tenant</option>
      </select>
    </div>
    <div class="row">
      <button id="runBtn">Run Invoke-ARI</button>
    </div>

    <div class="row">
      <div id="status" class="muted">Idle</div>
    </div>
  </div>

  <script>
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const userSpan = document.getElementById('userSpan');
    const appDiv = document.getElementById('app');
    const tenantSelect = document.getElementById('tenantSelect');
    const subscriptionSelect = document.getElementById('subscriptionSelect');
    const runBtn = document.getElementById('runBtn');
    const statusDiv = document.getElementById('status');

    async function getJSON(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    async function postJSON(url, body) {
      const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)});
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    async function refreshAuth() {
      try {
        const me = await getJSON('/api/me');
        loginBtn.classList.add('hidden');
        logoutBtn.classList.remove('hidden');
      userSpan.textContent = `Signed in as ${me.userDetails || me.username || 'unknown'}`;
        appDiv.classList.remove('hidden');
        await loadTenants();
      } catch {
        loginBtn.classList.remove('hidden');
        logoutBtn.classList.add('hidden');
        userSpan.textContent = '';
        appDiv.classList.add('hidden');
      }
    }

    async function loadTenants() {
      tenantSelect.innerHTML = '';
      const data = await getJSON('/api/tenants');
      for (const t of data.tenants) {
        const opt = document.createElement('option');
        opt.value = t.tenantId;
        opt.textContent = `${t.displayName || t.tenantId} (${t.tenantId})`;
        tenantSelect.appendChild(opt);
      }
      await loadSubscriptions();
    }

    async function loadSubscriptions() {
      subscriptionSelect.innerHTML = '<option value="">All accessible in tenant</option>';
      const tenantId = tenantSelect.value;
      if (!tenantId) return;
      const data = await getJSON(`/api/subscriptions?tenantId=${encodeURIComponent(tenantId)}`);
      for (const s of data.subscriptions) {
        const opt = document.createElement('option');
        opt.value = s.subscriptionId;
        opt.textContent = `${s.displayName} (${s.subscriptionId})`;
        subscriptionSelect.appendChild(opt);
      }
    }

    async function pollJob(jobId) {
      const poll = async () => {
        try {
          const j = await getJSON(`/api/jobs/${jobId}/status`);
          const files = (j.files || []).map(f => `- ${f}`).join('\n');
          statusDiv.textContent = `Status: ${j.status}\nStarted: ${j.startedAt}\nEnded: ${j.endedAt || ''}\nOutputs: /outputs/${jobId}/\n${files}\nLog: /api/jobs/${jobId}/log`;
          if (j.status === 'running') setTimeout(poll, 5000);
        } catch (e) {
          statusDiv.textContent = 'Failed to get job status: ' + e.message;
        }
      };
      poll();
    }

    loginBtn.onclick = () => { window.location = '/auth/login'; };
    logoutBtn.onclick = async () => { await postJSON('/auth/logout', {}); await refreshAuth(); };
    tenantSelect.onchange = loadSubscriptions;

    runBtn.onclick = async () => {
      statusDiv.textContent = 'Starting...';
      const tenantId = tenantSelect.value;
      const subscriptionId = subscriptionSelect.value || undefined;
      const res = await postJSON('/api/run', { tenantId, subscriptionId });
      statusDiv.textContent = `Job started: ${res.jobId}\nLog: ${res.logUrl}`;
      await pollJob(res.jobId);
    };

    refreshAuth();
  </script>
</body>
</html>
